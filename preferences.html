<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Preferences | Weekplan.ai</title>
<link rel="stylesheet" href="/styles.css" />
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
    --blue:#2563eb; --ring:rgba(37,99,235,.12); --line:#e5e7eb;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .center{min-height:100%;display:grid;place-items:center;padding:18px}
  .hero{max-width:720px;text-align:center;padding:16px}
  h1{margin:.2rem 0 0;font-size:36px;letter-spacing:-.02em}
  p.sub{margin:.6rem 0 1.6rem;color:var(--muted)}
  .btn{
    border:0;cursor:pointer;border-radius:16px;
    font-weight:800;padding:16px 24px;box-shadow:0 10px 26px var(--ring);
    background:linear-gradient(135deg,#60a5fa,#2563eb);color:#fff;
  }
  .btn:active{transform:translateY(1px)}
  .btn.alt{background:#eff6ff;color:#1e3a8a;border:1px solid #bfdbfe;box-shadow:none}
  .btn.slim{padding:10px 14px;border-radius:10px}

  /* Dialogs */
  dialog{width:100%;max-width:720px;border:0;padding:0;margin:0 auto;background:transparent}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  .sheet{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.12);overflow:hidden}
  .hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
  .title{font-weight:900}
  .close{border:1px solid var(--line);background:#fff;color:var(--ink);border-radius:10px;padding:8px 10px;cursor:pointer}
  .bd{padding:14px 16px}
  .muted{color:var(--muted)}
  .hint{color:#94a3b8;font-size:.92rem}

  textarea,input,select{width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none}
  textarea::placeholder,input::placeholder{color:#94a3b8}

  .row{display:grid;gap:10px}
  .row.two{grid-template-columns:1fr 1fr}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}

  /* Quick picks (compact) */
  .checks{display:grid;gap:8px;margin-top:10px;grid-template-columns:1fr 1fr}
  @media(max-width:420px){ .checks{grid-template-columns:1fr} }
  .check{display:flex;align-items:center;gap:10px;background:#f8fafc;border:1px solid var(--line);padding:8px 10px;border-radius:10px;font-size:.95rem}
  .check input{width:16px;height:16px}

  /* Quick mini-wizard */
  .qstep{display:none}
  .qstep.show{display:block;animation:fade .18s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
  .dot{width:8px;height:8px;border-radius:999px;background:#e5e7eb}
  .dot.active{background:#2563eb}

  /* Hub (unchanged) */
  .tiles{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
  @media(max-width:640px){.tiles{grid-template-columns:1fr 1fr}}
  .tile{border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px;cursor:pointer;display:flex;gap:10px;align-items:center;transition:box-shadow .12s, transform .06s}
  .tile:hover{box-shadow:0 8px 22px var(--ring)} .tile:active{transform:translateY(1px)}
  .badge{margin-left:auto;background:#e0e7ff;color:#1e3a8a;border-radius:999px;padding:4px 8px;font-weight:700;font-size:.8rem}
  .panel{margin-top:12px;border:1px solid var(--line);border-radius:14px;padding:12px;background:#fff}

  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);background:#f8fafc;color:#0f172a;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
  .chip[aria-pressed="true"]{background:#e0f2fe;border-color:#93c5fd}
  .sl{margin-top:6px;color:var(--muted);font-size:.9rem}

  /* JSON peek */
  details.peek{margin-top:10px}
  .peek .box{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;background:#0b1220;color:#e8edf3;border-radius:12px;padding:12px;max-height:200px;overflow:auto}
</style>
</head>
<body>
<div class="center">
  <section class="hero">
    <h1>Ready to eat smarter?</h1>
    <p class="sub">Start with one note or choose a few preferences. You can keep it simple or go deepâ€”your call.</p>
    <button class="btn" id="getStarted">Get started</button>
  </section>
</div>

<!-- QUICK DIALOG (two-card) -->
<dialog id="quick">
  <div class="sheet">
    <div class="hd">
      <div class="title" id="qTitle">Before we get startedâ€¦</div>
      <button class="close" data-close>Close</button>
    </div>
    <div class="bd">

      <!-- STEP 1: BASICS -->
      <section class="qstep show" data-qstep="1">
        <p class="muted" style="margin-top:0">Letâ€™s agree on the basics for your plan.</p>
        <div class="row two" style="margin-bottom:10px">
          <div>
            <label class="muted">Servings per recipe</label>
            <select id="servings">
              <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
            </select>
            <div class="hint">How many people each dinner should serve.</div>
          </div>
          <div>
            <label class="muted">Units</label>
            <select id="units">
              <option value="metric" selected>Metric (g, ml)</option>
              <option value="us">US (oz, cups)</option>
            </select>
            <div class="hint">Measurement system for ingredients.</div>
          </div>
        </div>

        <div class="actions" style="justify-content:flex-end">
          <button class="btn" id="qContinue">Continue</button>
        </div>
        <div class="dots"><span class="dot active"></span><span class="dot"></span></div>
      </section>

      <!-- STEP 2: DETAILS -->
      <section class="qstep" data-qstep="2">
        <label class="muted">Custom instructions (optional)</label>
        <textarea id="quickNote" placeholder="Tell the planner anything: goals, ingredients to avoid/include, cuisines, time limitsâ€¦"></textarea>

        <div class="muted" style="margin-top:10px">Pick any (optional)</div>
        <div class="checks">
          <label class="check"><input type="checkbox" value="save_time"> Save time</label>
          <label class="check"><input type="checkbox" value="weight_loss"> Weight loss</label>
          <label class="check"><input type="checkbox" value="muscle_gain"> Muscle gain</label>
          <label class="check"><input type="checkbox" value="vegetarian"> Vegetarian focus</label>
          <label class="check"><input type="checkbox" value="budget_friendly"> Budget friendly</label>
        </div>

        <div class="actions">
          <button class="btn" id="doQuick">Create Plan</button>
          <button class="btn alt" id="openHub">Help me find my perfect food plan</button>
          <button class="btn slim alt" id="qBack">Back</button>
        </div>

        <details class="peek" id="quickPeek">
          <summary class="muted">JSON preview</summary>
          <div class="box" id="quickJSON">{ }</div>
        </details>
        <div class="dots"><span class="dot"></span><span class="dot active"></span></div>
      </section>

    </div>
  </div>
</dialog>

<!-- HUB / TOPIC DIALOG (unchanged) -->
<dialog id="hub">
  <div class="sheet">
    <div class="hd">
      <div class="title">Tweak what matters (optional)</div>
      <button class="close" data-close>Close</button>
    </div>
    <div class="bd">
      <p class="muted" style="margin:0 0 10px">Pick a topic. Set just oneâ€”or keep going.</p>
      <div class="tiles" id="tiles"></div>
      <div id="panel" class="panel" hidden></div>
      <div class="actions">
        <button class="btn slim alt" id="clearPanel">Back to topics</button>
        <button class="btn" id="finish">Done for now</button>
      </div>
      <details class="peek">
        <summary class="muted">JSON preview</summary>
        <div class="box" id="hubJSON">{ }</div>
      </details>
    </div>
  </div>
</dialog>

<script>
/* ---------- State ---------- */
const $ = s => document.querySelector(s);

let state = {
  profileVersion:1,
  quickNote:'',
  goals:[],
  dietary:{dietStyle:'omnivore',allergies:[],intolerances:[],avoid:[],mustInclude:[]},
  taste:{cuisines:[],spiceTolerance:5,allowDesserts:true,proteinPrefs:[]},
  mealRules:{focusMeals:'dinner',servingsPerRecipe:2,leftoversPolicy:'none',timePerDinnerMin:30,varietyLevel:7},
  skillBudget:{skillLevel:'beginner',budgetLevel:'medium',equipment:[]},
  meta:{device:'web',savedAt:null,units:'metric'}
};

const PRESETS = {
  goals:['save_time','weight_loss','muscle_gain','enjoyment','learn_to_cook','consistency'],
  diet:['omnivore','vegetarian','vegan','pescatarian','flexitarian','keto','mediterranean'],
  allergies:['peanuts','lactose','gluten','shellfish','soy','eggs'],
  avoid:['mushrooms','olives','cilantro'],
  must:['chicken','rice','beans'],
  cuisines:['mediterranean','mexican','italian','indian','thai','japanese','nordic'],
  proteins:['chicken','fish','salmon','tofu','lentils','beans','eggs'],
  equipment:['stovetop','oven','microwave','air_fryer','slow_cooker','blender','pressure_cooker'],
  skill:['beginner','intermediate','advanced'],
  budget:['low','medium','high'],
  leftovers:['none','ok_for_lunch','prefer_leftovers'],
  servings:['1','2','4'],
  timeOpts:[{label:'â‰¤20 min',val:20},{label:'~30 min',val:30},{label:'45+ min',val:45}]
};

function exportObj(){
  return {
    profileVersion:1,
    quickNote: state.quickNote,
    goals:[...state.goals],
    dietary:{...state.dietary},
    taste:{...state.taste, allowDesserts: !!state.taste.allowDesserts},
    mealRules:{...state.mealRules},
    skillBudget:{...state.skillBudget},
    meta:{device:'web', savedAt:new Date().toISOString(), units: state.meta.units}
  };
}
function updateJSON(){
  $('#quickJSON').textContent = JSON.stringify(exportObj(), null, 2);
  $('#hubJSON').textContent   = JSON.stringify(exportObj(), null, 2);
}

/* ---------- Landing ---------- */
$('#getStarted').onclick = () => $('#quick').showModal();
document.querySelectorAll('[data-close]').forEach(b=> b.onclick = e => e.target.closest('dialog').close());

/* ---------- Quick step control ---------- */
const steps = Array.from(document.querySelectorAll('.qstep'));
function showQuickStep(n){
  steps.forEach(s => s.classList.toggle('show', +s.dataset.qstep === n));
  $('#qTitle').textContent = n===1 ? 'Before we get startedâ€¦' : 'Customize (optional)';
}
$('#qContinue').onclick = ()=> showQuickStep(2);
$('#qBack').onclick = ()=> showQuickStep(1);

/* Basics bindings */
$('#servings').addEventListener('change', e=>{ state.mealRules.servingsPerRecipe = +e.target.value; updateJSON(); });
$('#units').addEventListener('change', e=>{ state.meta.units = e.target.value; updateJSON(); });

/* Custom note live */
$('#quickNote').addEventListener('input', e=>{ state.quickNote = e.target.value.trim(); updateJSON(); });

/* Quick create */
$('#doQuick').onclick = ()=>{
  const chosen = Array.from(document.querySelectorAll('#quick .checks input:checked')).map(x=>x.value);
  state.quickNote = $('#quickNote').value.trim();
  state.goals = chosen.filter(v=>['save_time','weight_loss','muscle_gain'].includes(v));
  if(chosen.includes('vegetarian')) state.dietary.dietStyle='vegetarian';
  if(chosen.includes('budget_friendly')) state.skillBudget.budgetLevel='low';
  updateJSON();
  $('#quickPeek').open = true;
  alert('Plan ready (demo).');
};

/* ---------- Topic Hub (unchanged logic) ---------- */
$('#openHub').onclick = ()=> { buildTiles(); updateJSON(); $('#hub').showModal(); };

const TOPICS = [
  {id:'goals', label:'Goals', emoji:'ðŸŽ¯'},
  {id:'diet', label:'Diet style', emoji:'ðŸ¥—'},
  {id:'allergies', label:'Allergies', emoji:'âš ï¸'},
  {id:'avoid', label:'Never show', emoji:'ðŸš«'},
  {id:'must', label:'Must include', emoji:'âœ…'},
  {id:'time', label:'Time per dinner', emoji:'â±ï¸'},
  {id:'variety', label:'Variety', emoji:'ðŸ”'},
  {id:'skill', label:'Skill', emoji:'ðŸ§‘â€ðŸ³'},
  {id:'budget', label:'Budget', emoji:'ðŸ’¸'},
  {id:'leftovers', label:'Leftovers', emoji:'ðŸ±'},
  {id:'servings', label:'Servings', emoji:'ðŸ½ï¸'},
  {id:'cuisines', label:'Cuisines', emoji:'ðŸœ'},
  {id:'spice', label:'Spice', emoji:'ðŸŒ¶ï¸'},
  {id:'dessert', label:'Desserts', emoji:'ðŸ¨'},
  {id:'proteins', label:'Proteins', emoji:'ðŸ—'},
  {id:'equipment', label:'Equipment', emoji:'ðŸ”§'}
];

function buildTiles(){
  const wrap = $('#tiles'); wrap.innerHTML='';
  TOPICS.forEach(t=>{
    const tile=document.createElement('button');
    tile.type='button'; tile.className='tile';
    tile.innerHTML=`<span>${t.emoji}</span><span>${t.label}</span><span class="badge" id="b-${t.id}" hidden>Set</span>`;
    tile.onclick=()=> openTopic(t.id);
    wrap.appendChild(tile);
  });
  refreshBadges(); clearPanel();
}
function setBadge(id,on){ const b=$('#b-'+id); if(b) b.hidden=!on; }
function refreshBadges(){
  setBadge('goals', state.goals.length>0);
  setBadge('diet', state.dietary.dietStyle!=='omnivore');
  setBadge('allergies', state.dietary.allergies.length>0);
  setBadge('avoid', state.dietary.avoid.length>0);
  setBadge('must', state.dietary.mustInclude.length>0);
  setBadge('time', state.mealRules.timePerDinnerMin!==30);
  setBadge('variety', state.mealRules.varietyLevel!==7);
  setBadge('skill', state.skillBudget.skillLevel!=='beginner');
  setBadge('budget', state.skillBudget.budgetLevel!=='medium');
  setBadge('leftovers', state.mealRules.leftoversPolicy!=='none');
  setBadge('servings', state.mealRules.servingsPerRecipe!==2);
  setBadge('cuisines', state.taste.cuisines.length>0);
  setBadge('spice', state.taste.spiceTolerance!==5);
  setBadge('dessert', state.taste.allowDesserts===false);
  setBadge('proteins', state.taste.proteinPrefs.length>0);
  setBadge('equipment', state.skillBudget.equipment.length>0);
}

function chipField(container, arr, preset, single=false){
  container.innerHTML='';
  const list=[...new Set([...(preset||[]), ...(Array.isArray(arr)?arr:[arr])].filter(Boolean))];
  list.forEach(v=>{
    const b=document.createElement('button');
    b.type='button'; b.className='chip'; b.textContent=v;
    const isOn = single ? (arr===v) : (arr||[]).includes(v);
    b.setAttribute('aria-pressed', String(isOn));
    b.onclick=()=>{
      if(single){ arr=v; }
      else{
        const i=(arr||[]).indexOf(v);
        if(i>=0) arr.splice(i,1); else (arr||[]).push(v);
      }
      renderTopic(); updateJSON(); refreshBadges();
    };
    container.appendChild(b);
  });
  return arr;
}

let currentTopic=null;
function openTopic(id){ currentTopic=id; renderTopic(); }
function renderTopic(){
  if(!currentTopic) return;
  const id=currentTopic; const p=$('#panel'); p.hidden=false; p.innerHTML='';
  const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
  head.innerHTML=`<strong>${TOPICS.find(t=>t.id===id)?.label||id}</strong>`;
  const done=document.createElement('button'); done.className='btn slim alt'; done.textContent='Done'; done.onclick=()=>{ clearPanel(); refreshBadges(); };
  head.appendChild(done); p.appendChild(head);

  const box=document.createElement('div');
  const mkChips=(arr,preset,single=false)=>{ const c=document.createElement('div'); c.className='chips'; if(single){ chipField(c, arr, preset, true); } else { chipField(c, arr, preset); } box.appendChild(c); return c; };
  const mkAdd=(ph,arr)=>{ const i=document.createElement('input'); i.placeholder=ph; i.onkeydown=e=>{ if(e.key==='Enter'){ e.preventDefault(); const v=i.value.trim().toLowerCase(); if(v && !arr.includes(v)){ arr.push(v); renderTopic(); updateJSON(); } } }; box.appendChild(i); };

  switch(id){
    case 'goals': mkChips(state.goals, PRESETS.goals); mkAdd('Add goal (Enter)', state.goals); break;
    case 'diet': { const c=mkChips(state.dietary.dietStyle, PRESETS.diet, true); c.onclick=e=>{ const v=e.target.textContent; if(PRESETS.diet.includes(v)){ state.dietary.dietStyle=v; renderTopic(); updateJSON(); } }; break; }
    case 'allergies': mkChips(state.dietary.allergies, PRESETS.allergies); mkAdd('Add allergy (Enter)', state.dietary.allergies); break;
    case 'avoid': mkChips(state.dietary.avoid, PRESETS.avoid); mkAdd('Add â€œnever showâ€ (Enter)', state.dietary.avoid); break;
    case 'must': mkChips(state.dietary.mustInclude, PRESETS.must); mkAdd('Add must-include (Enter)', state.dietary.mustInclude); break;
    case 'time': { const c=document.createElement('div'); c.className='chips'; PRESETS.timeOpts.forEach(o=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=o.label; b.setAttribute('aria-pressed', String(state.mealRules.timePerDinnerMin===o.val)); b.onclick=()=>{ state.mealRules.timePerDinnerMin=o.val; renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'variety': { box.innerHTML=`<input id="var" type="range" min="0" max="10" value="${state.mealRules.varietyLevel}"/><div class="sl">Variety: <span id="vo">${state.mealRules.varietyLevel}</span>/10</div>`; box.querySelector('#var').oninput=e=>{ state.mealRules.varietyLevel=+e.target.value; box.querySelector('#vo').textContent=e.target.value; updateJSON(); }; break; }
    case 'skill': { const c=document.createElement('div'); c.className='chips'; PRESETS.skill.forEach(v=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=v; b.setAttribute('aria-pressed', String(state.skillBudget.skillLevel===v)); b.onclick=()=>{ state.skillBudget.skillLevel=v; renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'budget': { const c=document.createElement('div'); c.className='chips'; PRESETS.budget.forEach(v=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=v; b.setAttribute('aria-pressed', String(state.skillBudget.budgetLevel===v)); b.onclick=()=>{ state.skillBudget.budgetLevel=v; renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'leftovers': { const c=document.createElement('div'); c.className='chips'; PRESETS.leftovers.forEach(v=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=v; b.setAttribute('aria-pressed', String(state.mealRules.leftoversPolicy===v)); b.onclick=()=>{ state.mealRules.leftoversPolicy=v; renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'servings': { const c=document.createElement('div'); c.className='chips'; ['1','2','3','4','5','6'].forEach(v=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=v; b.setAttribute('aria-pressed', String(state.mealRules.servingsPerRecipe===+v)); b.onclick=()=>{ state.mealRules.servingsPerRecipe=+v; renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'cuisines': mkChips(state.taste.cuisines, PRESETS.cuisines); mkAdd('Add cuisine (Enter)', state.taste.cuisines); break;
    case 'spice': { box.innerHTML=`<input id="sp" type="range" min="0" max="10" value="${state.taste.spiceTolerance}"/><div class="sl">Spice: <span id="so">${state.taste.spiceTolerance}</span>/10</div>`; box.querySelector('#sp').oninput=e=>{ state.taste.spiceTolerance=+e.target.value; box.querySelector('#so').textContent=e.target.value; updateJSON(); }; break; }
    case 'dessert': { const c=document.createElement('div'); c.className='chips'; ['allow','no'].forEach(v=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=(v==='allow'?'Allow sometimes':'No desserts'); b.setAttribute('aria-pressed', String( (state.taste.allowDesserts && v==='allow') || (!state.taste.allowDesserts && v==='no') )); b.onclick=()=>{ state.taste.allowDesserts=(v==='allow'); renderTopic(); updateJSON(); }; c.appendChild(b); }); box.appendChild(c); break; }
    case 'proteins': mkChips(state.taste.proteinPrefs, PRESETS.proteins); mkAdd('Add protein (Enter)', state.taste.proteinPrefs); break;
    case 'equipment': mkChips(state.skillBudget.equipment, PRESETS.equipment); mkAdd('Add equipment (Enter)', state.skillBudget.equipment); break;
  }
  p.appendChild(box); updateJSON();
}
function clearPanel(){ currentTopic=null; const p=$('#panel'); p.hidden=true; p.innerHTML=''; }
$('#clearPanel').onclick = clearPanel;
$('#finish').onclick = ()=>{ state.meta.savedAt=new Date().toISOString(); updateJSON(); alert('Preferences ready (demo).'); };

/* Init */
updateJSON();
</script>
</body>
</html>

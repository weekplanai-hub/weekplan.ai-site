<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Preferences | Weekplan.ai</title>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
    --blue:#2563eb; --ring:rgba(37,99,235,.12); --line:#e5e7eb;
    --set-bg:#e0f2fe; --set-border:#93c5fd; --set-ink:#1e40af;
    --secondary:#06b6d4; --darkblue:#1e3a8a;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .center{min-height:100%;display:grid;place-items:center;padding:18px}
  .btn{border:0;cursor:pointer;border-radius:16px;font-weight:800;padding:16px 24px;box-shadow:0 10px 26px var(--ring);background:linear-gradient(135deg,#60a5fa,#2563eb);color:#fff}
  .btn:active{transform:translateY(1px)}
  .btn.alt{background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;box-shadow:none}
  .btn.dark{background:linear-gradient(135deg,#1e3a8a,#1e40af);color:#fff;box-shadow:none}
  .btn.ghost{background:#f8fafc;color:#1e3a8a;border:1px solid var(--line);box-shadow:none}
  .btn.slim{padding:10px 14px;border-radius:10px}

  dialog{width:100%;max-width:580px;border:0;padding:0;margin:0 auto;background:transparent}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  .sheet{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.12);overflow:hidden}
  .hd{display:flex;justify-content:flex-end;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line);gap:8px}
  .close{border:1px solid var(--line);background:#fff;color:#222;border-radius:10px;padding:8px 10px;cursor:pointer}
  .bd{padding:14px 16px}
  .muted{color:var(--muted)}
  .hint{color:#94a3b8;font-size:.92rem}

  textarea,input,select{width:100%;background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;outline:none}
  textarea::placeholder,input::placeholder{color:#94a3b8}

  .row{display:grid;gap:10px}
  .row.two{grid-template-columns:1fr 1fr}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;justify-content:center}

  .qstep{display:none}
  .qstep.show{display:block;animation:fade .18s ease-out}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
  .dot{width:8px;height:8px;border-radius:999px;background:#e5e7eb}
  .dot.active{background:#2563eb}

  .card-row{display:grid;grid-template-columns:1fr;gap:16px;margin:14px 0}
  .pref-card{flex:1;min-width:200px;background:#f8fbff;border:1px solid #dbeafe;border-radius:18px;padding:16px;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,.04)}
  .pref-label{display:block;font-weight:700;margin-bottom:10px;color:#1e3a8a}
  .count{display:flex;align-items:center;justify-content:center;gap:16px;font-size:26px;font-weight:900}
  .circle-btn{background:#2563eb;color:#fff;border:none;width:40px;height:40px;border-radius:50%;font-size:22px;cursor:pointer}
  .circle-btn:active{transform:translateY(1px)}
  .meals{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
  .meal-btn{padding:10px 18px;border-radius:12px;border:2px solid #2563eb;background:#eff6ff;font-weight:700;cursor:pointer;transition:all .2s ease}
  .meal-btn.active{background:#2563eb;color:#fff;box-shadow:0 0 10px rgba(37,99,235,.6)}

  /* --- Dev panel (out of product UI) --- */
  .dev-wrap{max-width:980px;margin:22px auto 40px;padding:0 16px}
  .dev{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .dev .card{background:#fff;border:2px dashed #cbd5e1;border-radius:14px;padding:14px}
  .dev h3{margin:0 0 8px;font-size:16px}
  .dev small{color:#64748b}
  .dev .row{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
  .dev input[readonly]{background:#f8fafc}
  @media(max-width:720px){ .dev{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="center">
  <dialog id="quick" open>
    <div class="sheet">
      <div class="hd">
        <button class="close" data-close>Close</button>
      </div>
      <div class="bd">
        <section class="qstep show" data-qstep="1">
          <div class="card-row">
            <div class="pref-card">
              <label class="pref-label">Number of people</label>
              <div class="count">
                <button type="button" class="circle-btn" id="minusBtn">−</button>
                <span id="peopleCount">2</span>
                <button type="button" class="circle-btn" id="plusBtn">+</button>
              </div>
            </div>
          </div>
          <div class="pref-card" style="margin-top:10px">
            <label class="pref-label">Select meals</label>
            <div class="meals" id="mealChoices">
              <button type="button" class="meal-btn active" data-meal="breakfast">Breakfast</button>
              <button type="button" class="meal-btn active" data-meal="lunch">Lunch</button>
              <button type="button" class="meal-btn active" data-meal="dinner">Dinner</button>
              <button type="button" class="meal-btn" data-meal="snacks">Snacks</button>
              <button type="button" class="meal-btn" data-meal="desserts">Desserts</button>
            </div>
          </div>
          <div class="actions" style="margin-top:18px">
            <button class="btn dark" id="qContinue">Help me personalize</button>
            <button class="btn" id="doQuickFromFirst">Create Week Plan</button>
          </div>
          <div class="dots"><span class="dot active"></span><span class="dot"></span></div>
        </section>

        <section class="qstep" data-qstep="2">
          <h2 class="step-title">Personalization – have it your way!</h2>
          <p class="lead">Add your own preferences and customize.</p>
          <div class="note-wrap">
            <label class="muted">Custom instructions (optional)</label>
            <textarea class="note" id="quickNote" rows="5" placeholder="Tell the planner anything: goals, ingredients to avoid/include, cuisines, time limits…"></textarea>
          </div>
          <div class="actions" style="margin-top:14px">
            <button class="btn" id="doQuick">Create Plan</button>
            <button class="btn slim ghost" id="qBack">Back</button>
          </div>
          <div class="dots"><span class="dot"></span><span class="dot active"></span></div>
        </section>
      </div>
    </div>
  </dialog>
</div>

<!-- Developer-only utilities -->
<section class="dev-wrap" aria-label="Developer utilities">
  <div class="dev">
    <div class="card">
      <h3>Save to database</h3>
      <div class="row">
        <button class="btn" id="devSave">Save current prefs</button>
        <small class="muted">Saves: number of people + selected meals.</small>
      </div>
    </div>
    <div class="card">
      <h3>Import from database</h3>
      <div class="row">
        <button class="btn alt" id="devLoad">Import & preview</button>
        <input id="devPeople" readonly placeholder="people" />
        <input id="devMeals" readonly placeholder="meals (comma-separated)" />
      </div>
    </div>
  </div>
</section>

<!-- Supabase client + init -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="/supabase.js"></script>

<script>
const $ = s => document.querySelector(s);
const steps = Array.from(document.querySelectorAll('.qstep'));
function showQuickStep(n){ steps.forEach(s => s.classList.toggle('show', +s.dataset.qstep === n)); }
$('#qContinue').onclick = ()=> showQuickStep(2);
$('#qBack').onclick = ()=> showQuickStep(1);
$('#minusBtn').onclick = ()=>{ let c = +$('#peopleCount').textContent; if(c>1) $('#peopleCount').textContent=c-1; };
$('#plusBtn').onclick = ()=>{ let c = +$('#peopleCount').textContent; $('#peopleCount').textContent=c+1; };
document.querySelectorAll('.meal-btn').forEach(btn=>{ btn.onclick = ()=> btn.classList.toggle('active'); });
$('#doQuick').onclick = ()=> alert('Plan created (demo)');
$('#doQuickFromFirst').onclick = ()=> alert('Week Plan created (demo)');
document.querySelectorAll('[data-close]').forEach(b=> b.onclick = e => e.target.closest('dialog').close());

// --- Helpers
function getCurrentPrefs(){
  const people = +$('#peopleCount').textContent;
  const meals = Array.from(document.querySelectorAll('.meal-btn'))
    .filter(b => b.classList.contains('active'))
    .map(b => b.dataset.meal);
  return { people, meals };
}
function applyPrefs(pref){
  if(!pref) return;
  if(typeof pref.people === 'number' && pref.people>0){ $('#peopleCount').textContent = pref.people; }
  if(Array.isArray(pref.meals)){
    document.querySelectorAll('.meal-btn').forEach(b=>{
      b.classList.toggle('active', pref.meals.includes(b.dataset.meal));
    });
  }
}

// --- Save to Supabase ---
$('#devSave').onclick = async () => {
  const { people, meals } = getCurrentPrefs();
  try {
    const { error } = await sb.from('prefs').insert([{ people, meals }]);
    if (error) throw error;
    alert('Saved to Supabase ✅');
  } catch (err) {
    console.error(err);
    alert('Save failed ❌: ' + err.message);
  }
};

// --- Load from Supabase ---
$('#devLoad').onclick = async () => {
  try {
    const { data, error } = await sb
      .from('prefs')
      .select('*')
      .order('id', { ascending: false })
      .limit(1);

    if (error) throw error;
    if (!data || !data.length) { alert('No rows in prefs yet.'); return; }

    const pref = data[0];
    $('#devPeople').value = pref.people ?? '';
    $('#devMeals').value  = Array.isArray(pref.meals) ? pref.meals.join(', ') : '';
    applyPrefs(pref);
    alert('Imported last row from Supabase ✅');
  } catch (err) {
    console.error(err);
    alert('Load failed ❌: ' + err.message);
  }
};
</script>
</body>
</html>

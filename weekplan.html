<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekplan.ai â€” Forbedret Ukeplanner</title>
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --text: #1a202c;
      --muted: #718096;
      --accent: #4299e1;
      --success: #48bb78;
      --warning: #ed8936;
      --error: #e53e3e;
      --border: #e2e8f0;
      --shadow: 0 10px 25px rgba(0,0,0,0.1);
      --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    body{background:#f8fafc;color:var(--text);line-height:1.6}
    .container{max-width:1800px;margin:0 auto;padding:20px}

    /* Header */
    .header{background:rgba(255,255,255,.95);backdrop-filter:blur(10px);border-radius:var(--radius);padding:20px;margin-bottom:30px;box-shadow:var(--shadow)}
    .nav{display:flex;justify-content:space-between;align-items:center}
    .brand{font-size:28px;font-weight:800;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .status-badge{padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;background:var(--success);color:#fff}
    .status-badge.success{background:var(--success)}
    .status-badge.error{background:var(--error)}
    .status-badge.warning{background:var(--warning)}
    .status-badge.info{background:var(--accent)}

    /* Cards */
    .card{background:var(--panel);border-radius:var(--radius);padding:30px;margin-bottom:30px;box-shadow:var(--shadow);transition:var(--transition)}
    .card:hover{box-shadow:var(--shadow-hover);transform:translateY(-2px)}
    .card-title{font-size:24px;font-weight:700;margin:0 0 20px 0;color:var(--text)}

    /* Week Layout */
    .week-container{display:grid;grid-template-columns:repeat(7,1fr);gap:16px}
    @media (max-width:1600px){.week-container{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:1200px){.week-container{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:900px){.week-container{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.week-container{grid-template-columns:1fr}}

    .day-card{background:var(--panel);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);transition:var(--transition);min-height:120px;min-width:0}
    .day-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}

    .day-header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
    .day-title{font-size:16px;font-weight:700;color:var(--text);margin:0;flex:1}

    .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:var(--transition);font-size:14px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:linear-gradient(45deg,var(--accent),#667eea);color:#fff;box-shadow:0 4px 15px rgba(66,153,225,.3)}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(66,153,225,.4)}
    .btn-alt{background:#f7fafc;color:#4299e1;border:1px solid #e2e8f0}
    .btn-alt:hover{background:#edf2f7;border-color:#cbd5e0}

    .day-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:60px;color:var(--muted);font-style:italic;font-size:12px}
    .day-empty svg{width:24px;height:24px;margin-bottom:6px;opacity:.5}

    /* Meal tiles (samme som fÃ¸r, forkortet litt her) */
    .meal-tile{background:#fff;border-radius:16px;overflow:visible;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:all .3s cubic-bezier(.25,.46,.45,.94);margin-bottom:12px;position:relative}
    .meal-tile:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .meal-header{position:relative;height:60px;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;color:#fff;border-radius:16px 16px 0 0;overflow:hidden}
    .meal-header.breakfast{background:linear-gradient(135deg,#ff9a56 0%,#ff6b35 100%)}
    .meal-header.lunch{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%)}
    .meal-header.dinner{background:linear-gradient(135deg,#4299e1 0%,#3182ce 100%)}
    .meal-header.supper{background:linear-gradient(135deg,#9f7aea 0%,#805ad5 100%)}
    .meal-type-label{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
    .meal-icon{position:absolute;top:45px;left:50%;transform:translateX(-50%);width:50px;height:50px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:2}
    .meal-icon svg{width:24px;height:24px;color:#4a5568}
    .meal-content{padding:35px 16px 16px;text-align:center}
    .meal-title{font-size:16px;font-weight:600;color:#1a202c;margin:0 0 6px 0;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .meal-description{color:#718096;font-size:12px;margin:0 0 12px 0;line-height:1.4}
    .meal-stats{display:flex;justify-content:space-between;margin:8px 0}
    .stat{display:flex;align-items:center;gap:4px;font-size:11px;color:#4a5568;font-weight:500}
    .meal-actions{display:flex;gap:8px;justify-content:center}
    .action-btn{padding:8px 12px;border-radius:12px;font-weight:600;font-size:12px;border:none;cursor:pointer;transition:var(--transition);flex:1}
    .action-btn.secondary{background:#f7fafc;color:#4299e1;border:1px solid #e2e8f0}
    .action-btn.secondary:hover{background:#edf2f7;border-color:#cbd5e0}
    .action-btn.primary{background:#4299e1;color:#fff;box-shadow:0 2px 6px rgba(66,153,225,.3)}
    .action-btn.primary:hover{background:#3182ce;transform:translateY(-1px);box-shadow:0 4px 8px rgba(66,153,225,.4)}

    /* Modal */
    .recipe-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);opacity:0;transition:opacity .2s ease}
    .recipe-popover{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.95);min-width:400px;max-width:700px;width:90vw;max-height:85vh;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);padding:40px;z-index:1001;opacity:0;transition:all .2s cubic-bezier(.25,.46,.45,.94);overflow-y:auto}
    .recipe-close{position:absolute;top:20px;right:20px;background:#f7fafc;border:none;font-size:24px;cursor:pointer;color:#718096;padding:12px;border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
    .recipe-close:hover{background:#edf2f7;color:#4a5568;transform:scale(1.05)}
    .pre{background:#f8fafc;padding:20px;border-radius:12px;border-left:4px solid var(--accent);white-space:pre-wrap;font-family:ui-sans-serif,system-ui,sans-serif;font-size:15px;line-height:1.6;color:#2d3748}

    .week-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:16px;flex-wrap:wrap}
    .week-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .week-actions .btn{display:inline-flex;align-items:center;gap:8px}
    .status-message{padding:12px 16px;border-radius:8px;margin-top:16px;font-weight:600}
    .status-success{background:rgba(72,187,120,.1);color:var(--success);border:1px solid var(--success)}
    .status-error{background:rgba(229,62,62,.1);color:var(--error);border:1px solid var(--error)}
    .status-warning{background:rgba(237,137,54,.12);color:var(--warning);border:1px solid var(--warning)}
    .status-info{background:rgba(66,153,225,.12);color:var(--accent);border:1px solid var(--accent)}

    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .animate-in{animation:slideIn .5s ease-out}

    /* meal type color dots (ikke essensielt men greit Ã¥ beholde) */
    .meal-slot[data-meal="B"] .meal-type{color:#ed8936}
    .meal-slot[data-meal="L"] .meal-type{color:#48bb78}
    .meal-slot[data-meal="D"] .meal-type{color:#4299e1}
    .meal-slot[data-meal="S"] .meal-type{color:#9f7aea}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <nav class="nav">
        <h1 class="brand">Weekplan.ai</h1>
        <div class="status-badge" id="status-badge">Klar</div>
      </nav>
    </header>

    <!-- Week Plan -->
    <section class="card">
      <div class="week-header">
        <h2 class="card-title">ðŸ“… Din Ukeplan</h2>
        <div class="week-actions">
          <button class="btn btn-primary" id="generateWeekBtn" type="button">
            <span aria-hidden="true">â–¶</span>
            Generer ukeplan
          </button>
        </div>
      </div>
      <div id="weekContainer" class="week-container"></div>
      <div id="statusMessage"></div>
    </section>

    <!-- System Info -->
    <details class="card">
      <summary style="cursor:pointer;font-weight:600">ðŸ”§ System Info</summary>
      <div id="systemInfo" class="pre">Ingen data ennÃ¥...</div>
    </details>
  </div>

  <script type="module">
// --- (1) ForsÃ¸k Ã¥ importere byggere fra menuDemoPrompt.js ---
let DEMO_PROMPT, buildDemoPromptForDay, extractSystemMenus;

async function importMenuBuilder() {
  // 1) absolutt
  try {
    const mod = await import('/tools/menuDemoPrompt.js');
    DEMO_PROMPT = mod?.DEMO_PROMPT;
    buildDemoPromptForDay = mod?.buildDemoPromptForDay;
    extractSystemMenus = mod?.extractSystemMenus;
    return;
  } catch {}

  // 2) relativ (hvis HTML-en ligger i samme mappe som /tools)
  try {
    const mod = await import('./tools/menuDemoPrompt.js');
    DEMO_PROMPT = mod?.DEMO_PROMPT;
    buildDemoPromptForDay = mod?.buildDemoPromptForDay;
    extractSystemMenus = mod?.extractSystemMenus;
  } catch {
    // stille fallback â€“ vi har mock i runPromptViaApiManager
  }
}
await importMenuBuilder();


    // --- (2) Dag- og mÃ¥ltids-mapping ---
    const dayMapping = {
      1000: { name: 'Mandag', short: 'Man' },
      1001: { name: 'Tirsdag', short: 'Tir' },
      1002: { name: 'Onsdag', short: 'Ons' },
      1003: { name: 'Torsdag', short: 'Tor' },
      1004: { name: 'Fredag', short: 'Fre' },
      1005: { name: 'LÃ¸rdag', short: 'LÃ¸r' },
      1006: { name: 'SÃ¸ndag', short: 'SÃ¸n' }
    };
    const mealMapping = { B:'Frokost', L:'Lunsj', D:'Middag', S:'Kveldsmat' };

    // --- (3) UI helpers ---
    function showStatus(message, type='success'){
      const allowed = new Set(['success','error','warning','info']);
      if (!allowed.has(type)) type = 'info';
      const statusEl = document.getElementById('statusMessage');
      if (statusEl) {
        statusEl.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
      }
      const badgeEl = document.getElementById('status-badge');
      if (badgeEl) {
        const labelMap = {
          success: 'âœ… Klar',
          error: 'âŒ Feil',
          warning: 'âš ï¸ Sjekk',
          info: 'â„¹ï¸ Info'
        };
        badgeEl.textContent = labelMap[type] || 'â„¹ï¸ Status';
        badgeEl.className = `status-badge ${type}`;
      }
    }

        // --- (4) Bygg uke-grid (med spesialknapper pÃ¥ Mandag) ---
    function initializeWeek(){
      const container = document.getElementById('weekContainer');
      if (!container) return;
      container.innerHTML = '';

      Object.entries(dayMapping).forEach(([code, day]) => {
        const card = document.createElement('div');
        card.className = 'day-card animate-in';
        card.setAttribute('data-day-code', code);

        card.innerHTML = `
          <div class="day-header">
            <h3 class="day-title">${day.name}</h3>
          </div>
          <div class="day-content">
            <div class="day-empty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Ingen mÃ¥ltider planlagt
            </div>
          </div>
        `;

        container.appendChild(card);
      });

      const systemInfoEl = document.getElementById('systemInfo');
      if (systemInfoEl) {
        systemInfoEl.textContent = 'Ingen data ennÃ¥...';
      }

      showStatus('Uke er klar. Trykk Â«Generer ukeplanÂ».', 'success');
    }

    // Eksponer funksjonen globalt
    window.initializeWeek = initializeWeek;


    // --- (5) Parser (samme logikk som fÃ¸r) ---
    function parseAIOutput(text){
      const lines = text.trim().split('\n');
      const result = {};
      let currentDay = null;
      let currentMeal = null;
      let currentSection = null;

      lines.forEach((rawLine, idx) => {
        let line = rawLine.trim();
        if (!line) return;

        // Day
        const dayMatch = line.match(/^(100[0-6])\s+(.+)$/);
        if (dayMatch){
          currentDay = dayMatch[1];
          result[currentDay] = { name: dayMatch[2], meals: {} };
          currentMeal = null;
          currentSection = null;
          return;
        }

        // Meal
        const mealMatch = line.match(/^([2-5])000\s+([BLDS])$/);
        if (mealMatch && currentDay){
          currentMeal = mealMatch[2];
          result[currentDay].meals[currentMeal] = {};
          currentSection = null;
          return;
        }

        // Content 2001/2002/2003
        const contentMatch = line.match(/^([2-5])00([1-3])\s+(.+)$/);
        if (contentMatch && currentDay && currentMeal){
          const section = contentMatch[2];
          const content = contentMatch[3];
          if (section === '1'){
            result[currentDay].meals[currentMeal].title = content;
          } else if (section === '2'){
            result[currentDay].meals[currentMeal].recipe = [content];
            currentSection = 'recipe';
          } else if (section === '3'){
            result[currentDay].meals[currentMeal].shopping = [content];
            currentSection = 'shopping';
          }
          return;
        }

        // Continuation
        if (currentDay && currentMeal && currentSection && line){
          const meal = result[currentDay].meals[currentMeal];
          if (currentSection === 'recipe' && meal.recipe){
            meal.recipe.push(line);
          } else if (currentSection === 'shopping' && meal.shopping){
            meal.shopping.push(line);
          }
        }

        // System (9000)
        if (line.startsWith('9000')){
          result.system = lines.slice(idx + 1).join('\n');
        }
      });

      return result;
    }

    function getSelectionErrorCode(){
      return window.WeekplanBridge?.API_SELECTION_REQUIRED || 'API_SELECTION_REQUIRED';
    }

    function isSelectionError(err){
      if (!err) return false;
      if (err.code && err.code === getSelectionErrorCode()) return true;
      const msg = String(err.message || '').toLowerCase();
      return msg.includes('api-oppsett') || msg.includes('api manager');
    }

    function fallbackExtractSystemMenus(text){
      if (!text) return [];
      const raw = String(text);
      const trimmed = raw.split('\n').map(line => line.trim()).filter(Boolean);
      if (!trimmed.length) return [];
      const startIdx = trimmed.findIndex(line => /^9000/.test(line));
      const relevant = startIdx === -1 ? trimmed : trimmed.slice(startIdx + 1);
      return relevant
        .map(line => line.replace(/^[-â€¢\s]+/, '').trim())
        .filter(line => line && !/^9000/.test(line) && !/^errors?:/i.test(line));
    }

    function collectSystemMenus(rawOutput, parsedSystemText = ''){
      const extractor = (typeof extractSystemMenus === 'function')
        ? extractSystemMenus
        : fallbackExtractSystemMenus;
      let menus = extractor(rawOutput);
      if (!Array.isArray(menus)) menus = [];
      if (!menus.length && parsedSystemText) {
        const fallbackMenus = fallbackExtractSystemMenus(parsedSystemText);
        if (fallbackMenus.length) menus = fallbackMenus;
      }
      return menus
        .map(item => (typeof item === 'string' ? item.trim() : ''))
        .filter(Boolean);
    }

    function formatSystemMenusForDisplay(menus){
      if (!menus || !menus.length) return '';
      const unique = [];
      menus.forEach(item => {
        const clean = item.startsWith('-') ? item.slice(1).trim() : item.trim();
        if (clean && !unique.includes(clean)) unique.push(clean);
      });
      if (!unique.length) return '';
      const lines = unique.map(item => `- ${item}`);
      return ['System 9000 â€“ genererte menyer:', ...lines].join('\n');
    }

// --- (6) Render Ã©n vilkÃ¥rlig dag (1000â€“1006) ---
function renderDay(parsedData, dayCode){
  const dayObj = parsedData[String(dayCode)];
  const card = document.querySelector(`[data-day-code="${dayCode}"]`);
  if (!card) return;
  const dayContent = card.querySelector('.day-content');

  if (!dayObj || !dayObj.meals || Object.keys(dayObj.meals).length === 0){
    return; // behold tom state
  }

  const mealsHtml = Object.entries(dayObj.meals).map(([mealCode, mealData]) => {
    const mealType = getMealTypeClass(mealCode);
    const mealIcon = getMealIcon(mealCode);
    const recipeData = JSON.stringify(mealData.recipe || []);
    const shoppingData = JSON.stringify(mealData.shopping || []);
    const titleData = mealData.title || 'Ukjent mÃ¥ltid';
    return `
      <div class="meal-tile" data-meal="${mealCode}"
           data-recipe='${recipeData}'
           data-shopping='${shoppingData}'
           data-title='${titleData}'>
        <div class="meal-header ${mealType}">
          <div class="meal-type-label">
            ${mealMapping[mealCode] || 'MÃ¥ltid'}
            <svg class="meal-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m9 18 6-6-6-6"/>
            </svg>
          </div>
          <svg class="meal-heart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
          </svg>
        </div>
        <div class="meal-icon">${mealIcon}</div>
        <div class="meal-content">
          <h3 class="meal-title">${titleData}</h3>
          <p class="meal-description">Frisk, lett og proteinrik</p>
          <div class="meal-stats">
            <div class="stat">
              <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
              </svg> 25 min
            </div>
            <div class="stat">
              <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
              </svg> 2 pers
            </div>
            <div class="stat">
              <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg> Lett
            </div>
          </div>
          <div class="meal-actions">
            <button class="action-btn secondary" onclick="showShoppingFromElement(this)">Handleliste</button>
            <button class="action-btn primary" onclick="showRecipeFromElement(this)">Oppskrift</button>
          </div>
        </div>
      </div>
    `;
  }).join('');

  dayContent.innerHTML = mealsHtml;

  if (parsedData.system){
    document.getElementById('systemInfo').textContent = parsedData.system;
  }
}


    function getMealTypeClass(mealCode){
      return ({B:'breakfast',L:'lunch',D:'dinner',S:'supper'})[mealCode] || 'breakfast';
    }
    function getMealIcon(mealCode){
      const iconMap = {
        B:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20m8-10H4"/></svg>`,
        L:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>`,
        D:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V1"/><path d="M1 6h22"/></svg>`,
        S:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>`
      };
      return iconMap[mealCode] || iconMap.B;
    }

    // --- (7) Modal + helpers (samme som fÃ¸r) ---
    function showModal(title, sections){
      const modal = document.createElement('div');
      modal.innerHTML = `
        <div class="recipe-backdrop" onclick="closeModal()"></div>
        <div class="recipe-popover">
          <button class="recipe-close" onclick="closeModal()">Ã—</button>
          <div class="recipe-content">
            <h2 style="margin-top:0;color:#1a202c;font-size:28px;font-weight:800;">${title}</h2>
            ${sections.map(s=>`
              <div class="recipe-section">
                <h4 style="display:flex;gap:12px;align-items:center;color:var(--accent);font-size:20px;font-weight:700;margin:0 0 16px 0">
                  ${s.icon}${s.title}
                </h4>
                <div class="pre">${s.content}</div>
              </div>
            `).join('')}
          </div>
        </div>`;
      modal.className='recipe-modal';
      Object.assign(modal.style,{position:'fixed',inset:'0',zIndex:'1000'});
      document.body.appendChild(modal);
      document.body.style.overflow='hidden';
      setTimeout(()=>{
        modal.querySelector('.recipe-backdrop').style.opacity='1';
        const pop = modal.querySelector('.recipe-popover');
        pop.style.opacity='1'; pop.style.transform='translate(-50%,-50%) scale(1)';
      },10);
    }
    window.closeModal = function(){
      const modal=document.querySelector('.recipe-modal'); if(!modal) return;
      const backdrop=modal.querySelector('.recipe-backdrop'); const pop=modal.querySelector('.recipe-popover');
      backdrop.style.opacity='0'; pop.style.opacity='0'; pop.style.transform='translate(-50%,-50%) scale(.95)';
      setTimeout(()=>{ modal.remove(); document.body.style.overflow=''; },200);
    }
    window.showRecipeFromElement = (el)=>{
      const tile=el.closest('.meal-tile'); if(!tile) return;
      const title=tile.getAttribute('data-title');
      const recipe=JSON.parse(tile.getAttribute('data-recipe')||'[]');
      showModal(title,[{title:'Oppskrift',icon:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`,content:recipe.length?recipe.join('\n'):'Ingen oppskrift tilgjengelig'}]);
    };
    window.showShoppingFromElement = (el)=>{
      const tile=el.closest('.meal-tile'); if(!tile) return;
      const title=tile.getAttribute('data-title');
      const shopping=JSON.parse(tile.getAttribute('data-shopping')||'[]');
      showModal(title,[{title:'Handleliste',icon:`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8v6a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-6m-8 6h.01M16 19h.01"/></svg>`,content:shopping.length?shopping.join('\n'):'Ingen handleliste tilgjengelig'}]);
    };

    // --- (8) Nullstill Ã©n dag ---
    function refreshDay(dayCode){
      const dayCard=document.querySelector(`[data-day-code="${dayCode}"]`);
      if(!dayCard) return;
      const dayContent=dayCard.querySelector('.day-content');
      dayContent.innerHTML=`
        <div class="day-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          Ingen mÃ¥ltider planlagt
        </div>`;
      showStatus(`ðŸ”„ ${dayMapping[dayCode]?.name || 'Dag'} har blitt nullstilt`);
    }
    window.refreshDay = refreshDay;

// --- (9) API-bridge som kan kjÃ¸re vilkÃ¥rlig prompt (per dag) ---
async function runPromptViaApiManager(promptText, dayCodeForFallback = 1000){
  // A) WeekplanBridge med fri prompt
  const bridge = window.WeekplanBridge || {};
  if (typeof bridge.runPrompt === 'function'){
    try {
      return await bridge.runPrompt(promptText);
    } catch (e) {
      const selectionCode = bridge.API_SELECTION_REQUIRED || getSelectionErrorCode();
      if (e && (e.code === selectionCode || isSelectionError(e))) throw e;
      console.warn('WeekplanBridge.runPrompt feilet:', e);
    }
  }

  // B) Backend-proxy som aksepterer tekstprompt
  if (promptText){
    try {
      const res = await fetch('/api/run-demo', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: promptText })
      });
      if (!res.ok) throw new Error(`API svarte ${res.status}`);
      return await res.text();
    } catch (e) {
      console.warn('POST /api/run-demo feilet:', e);
      // vi faller ned til C)
    }
  }

  // C) Fallback: generer en minimal respons for gitt dayCode (lokal mock)
  const dayNameMap = {
    1000:'Monday',1001:'Tuesday',1002:'Wednesday',1003:'Thursday',
    1004:'Friday',1005:'Saturday',1006:'Sunday'
  };
  const dn = dayNameMap[dayCodeForFallback] || 'Monday';

  return [
    `${dayCodeForFallback} ${dn}`,
    '2000 D',
    '2001 Salmon with Roasted Potatoes',
    '2002 Recipe',
    'Preheat oven to 200Â°C.',
    'Toss potato wedges with olive oil, salt, pepper; roast 25 min.',
    'Season salmon; bake last 12â€“15 min.',
    'Serve with lemon and a green salad.',
    '2003 Shopping list',
    'Salmon fillets (2)',
    'Potatoes (600 g)',
    'Olive oil, salt, pepper, lemon',
    'Mixed greens',
    '9000 System',
    `- Salmon with Roasted Potatoes (${dayCodeForFallback}, D)`
  ].join('\n');
}

// --- (10) Generer HELE UKEN (1000â€“1006) via hovedknappen ---
async function generateWeekFromMonday(button){
  const triggerButton = button || document.getElementById('generateWeekBtn');
  const originalLabel = triggerButton ? triggerButton.textContent : '';
  const errors = [];
  const systemMenus = [];
  let abortError = null;
  const missingSelectionMessage = 'Velg API-nÃ¸kkel og modell i API Manager fÃ¸r du genererer ukeplanen.';

  const storedKey = (localStorage.getItem('api-key-openrouter') || '').trim();
  const storedModel = (localStorage.getItem('api-current-model-openrouter') || '').trim();
  if (!storedKey || !storedModel) {
    showStatus(missingSelectionMessage, 'error');
    const sysMissing = document.getElementById('systemInfo');
    if (sysMissing) sysMissing.textContent = missingSelectionMessage;
    return;
  }

  try{
    if (triggerButton) {
      triggerButton.disabled = true;
      triggerButton.textContent = 'Genererer ukeâ€¦';
    }
    showStatus('Jobber med Ã¥ hente menyer for hele uken â€¦', 'info');

    // Vis "laster" i alle dagkort fÃ¸rst
    for (let day = 1000; day <= 1006; day++){
      const card = document.querySelector(`[data-day-code="${day}"] .day-content`);
      if (card){
        card.innerHTML = `<div class="day-empty" style="height:auto">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg> Henter meny â€¦</div>`;
      }
    }

    for (let day = 1000; day <= 1006; day++){
      if (abortError) break;
      try {
        const previousMenusForPrompt = systemMenus.slice();
        const prompt = buildDemoPromptForDay
          ? buildDemoPromptForDay(day, undefined, undefined, previousMenusForPrompt)
          : DEMO_PROMPT;
        const raw = await runPromptViaApiManager(prompt, day);

        if (typeof raw !== 'string' || !raw.trim()) {
          throw new Error('Tomt svar fra API');
        }

        const parsed = parseAIOutput(raw);
        const dayKey = String(day);
        const oneDay = {};
        if (parsed[dayKey]) oneDay[dayKey] = parsed[dayKey];
        if (!oneDay[dayKey]) throw new Error('Ugyldig format for dag ' + day);

        renderDay(oneDay, day);
        showStatus(`âœ… Generert: ${dayMapping[day]?.name || day}`, 'success');

        const menusFromOutput = collectSystemMenus(raw, parsed.system);
        menusFromOutput.forEach(menu => {
          if (!systemMenus.includes(menu)) systemMenus.push(menu);
        });
      } catch (e){
        if (isSelectionError(e)) {
          abortError = e;
          break;
        }
        console.error(`Dag ${day} feilet:`, e);
        errors.push({ day, err: e });

        const card = document.querySelector(`[data-day-code="${day}"] .day-content`);
        if (card){
          card.innerHTML = `<div class="day-empty" style="height:auto;color:#e53e3e">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/>
            </svg> Kunne ikke hente meny</div>`;
        }
      }
    }

    const systemInfoEl = document.getElementById('systemInfo');
    if (systemInfoEl) {
      let infoText = formatSystemMenusForDisplay(systemMenus);
      if (!infoText && !abortError) {
        infoText = 'Ingen data ennÃ¥...';
      }
      if (abortError) {
        infoText = abortError.message || missingSelectionMessage;
      } else if (errors.length) {
        const list = errors.map(e => `â€¢ ${dayMapping[e.day]?.name || e.day}: ${e.err?.message || 'ukjent feil'}`).join('\n');
        infoText = `${infoText ? infoText + '\n\n' : ''}Errors:\n${list}`;
      }
      systemInfoEl.textContent = infoText;
    }

    if (abortError) {
      showStatus(abortError.message || missingSelectionMessage, 'error');
      return;
    }

    if (errors.length){
      showStatus('âš ï¸ Noen dager feilet. Se System Info / konsoll.', 'error');
    } else {
      showStatus('ðŸŽ‰ Hele uken er generert!', 'success');
    }

  } catch (err){
    console.error('Generering av uke feilet:', err);
    const fallbackMessage = err?.message || 'Ukjent feil under generering av uke.';
    showStatus(fallbackMessage, 'error');
    const sys = document.getElementById('systemInfo');
    if (sys) sys.textContent = fallbackMessage;
  } finally{
    if (triggerButton) {
      triggerButton.disabled = false;
      triggerButton.textContent = originalLabel || 'Generer ukeplan';
    }
  }
}

const generateWeekBtn = document.getElementById('generateWeekBtn');
if (generateWeekBtn) {
  generateWeekBtn.addEventListener('click', (e) => generateWeekFromMonday(e.currentTarget));
}

  
  </script>

  <!-- last scripts -->
  <script type="module" src="/tools/weekplan-bridge.js"></script>
<script type="module">
  // --- (11) Init (robust) ---
  window.addEventListener('DOMContentLoaded', () => {
    if (typeof window.initializeWeek === 'function') {
      window.initializeWeek();
    } else {
      console.error('initializeWeek er ikke definert. Sjekk konsoll for feil i hovedskriptet.');
      const statusEl = document.getElementById('statusMessage');
      if (statusEl) {
        statusEl.innerHTML = '<div class="status-message status-error">Feil: initializeWeek mangler. Ã…pne konsollen (F12) for detaljer.</div>';
      }
    }
  });
</script>

</body>
</html>
